<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Retiradas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.6.8/css/layui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.6.8/layui.min.js"></script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: #333;
            position: relative;
            min-height: 100vh;
            background: #c2ffdd !important;
            padding-bottom: 80px;
        }

        .navbar-top {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: linear-gradient(90deg, #28c76f 11.2%, #198754 78.9%) !important;
            color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }

        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .nav-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-title {
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            flex: 1;
        }

        .app-capsule {
            padding-top: 56px;
            min-height: 100vh;
        }

        .content-area {
            padding: 12px;
        }

        .withdrawal-card {
            background: rgba(255, 255, 255, 0.95) !important;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 3px 12px rgba(46, 125, 50, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 208, 148, 0.2);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .withdrawal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .withdrawal-date {
            font-size: 14px;
            color: #666;
        }

        .withdrawal-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: #FFF3CD;
            color: #856404;
        }

        .status-completed {
            background-color: #D4EDDA;
            color: #155724;
        }

        .status-rejected {
            background-color: #F8D7DA;
            color: #721C24;
        }

        .withdrawal-details {
            margin-top: 10px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 14px;
            color: #666;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .withdrawal-account {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 13px;
            color: #666;
        }

        .account-number {
            font-weight: 600;
            color: #198754;
        }

        .loading-more {
            text-align: center;
            padding: 15px;
            color: #666;
            display: none;
        }

        .no-withdrawals {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .withdrawal-amount {
            font-size: 18px;
            font-weight: 700;
            color: #198754;
        }

        .tax-amount {
            color: #DC3545;
        }

        .net-amount {
            color: #28A745;
        }
    </style>
</head>
<body>
    <div class="navbar-top">
        <div class="navbar-content">
            <div class="nav-icon" id="backButton">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
            </div>
            <div class="nav-title">Histórico de Saques</div>
            <div class="nav-icon" style="visibility: hidden;">
                <!-- Espaço vazio para alinhamento -->
            </div>
        </div>
    </div>

    <div class="app-capsule">
        <div class="content-area" id="withdrawalsContainer">
            <!-- Os cartões de retirada serão inseridos aqui via JavaScript -->
        </div>
        
        <div class="loading-more" id="loadingMore">
            <div class="layui-anim layui-anim-rotate layui-anim-loop">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#198754">
                    <path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
                </svg>
            </div>
            Carregando mais retiradas...
        </div>
        
        
    </div>

    <script>
    $(document).ready(function() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'index.html';
            return;
        }

        // Elementos da página
        const $container = $('#withdrawalsContainer');
        const $loadingMore = $('#loadingMore');
        const $noWithdrawals = $('#noWithdrawals');
        const $backButton = $('#backButton');

        // Variáveis para controle do scroll infinito
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const itemsPerPage = 10;

        // Função para formatar data
        function formatDate(dateString) {
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('pt-BR', options);
        }

        // Função para obter o nome do banco
        function getBankName(bankCode) {
            const banks = {
                'BFA': 'Banco de Fomento Angola',
                'BAI': 'Banco Angolano de Investimentos',
                'BIC': 'Banco BIC',
                'ATL': 'Banco Atlântico'
            };
            return banks[bankCode] || bankCode;
        }

        // Função para carregar retiradas
        async function loadWithdrawals(page) {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            $loadingMore.show();
            
            try {
                const response = await fetch(`http://localhost:3000/withdrawals?page=${page}&limit=${itemsPerPage}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar histórico');
                }
                
                const data = await response.json();
                
                if (data.data.length === 0) {
                    hasMore = false;
                    if (page === 1) {
                        $noWithdrawals.show();
                    }
                } else {
                    // Se for a primeira página e tiver menos de 10 itens, não mostra o "Carregando mais"
                    if (page === 1 && data.data.length < itemsPerPage) {
                        hasMore = false;
                    }
                    
                    data.data.forEach(withdrawal => {
                        const statusClass = `status-${withdrawal.status.toLowerCase()}`;
                        
                        const card = `
                            <div class="withdrawal-card">
                                <div class="withdrawal-header">
                                    <div class="withdrawal-date">${formatDate(withdrawal.createdAt)}</div>
                                    <div class="withdrawal-status ${statusClass}">
                                        ${withdrawal.status === 'PENDENTE' ? 'PENDENTE' : 
                                          withdrawal.status === 'CONCLUIDO' ? 'CONCLUÍDO' : 'RECUSADO'}
                                    </div>
                                </div>
                                
                                <div class="withdrawal-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Valor retirado:</span>
                                        <span class="detail-value withdrawal-amount">KZ ${withdrawal.valorBruto.toFixed(2)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Taxa (${(withdrawal.taxa * 100).toFixed(0)}%):</span>
                                        <span class="detail-value tax-amount">- KZ ${(withdrawal.valorBruto * withdrawal.taxa).toFixed(2)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Valor a receber:</span>
                                        <span class="detail-value net-amount">KZ ${withdrawal.valorLiquido.toFixed(2)}</span>
                                    </div>
                                </div>
                                
                                <div class="withdrawal-account">
                                    ${getBankName(withdrawal.banco)} • 
                                    <span class="account-number">•••• ${withdrawal.conta.slice(-4)}</span>
                                </div>
                            </div>
                        `;
                        
                        $container.append(card);
                    });
                    
                    currentPage++;
                }
                
            } catch (error) {
                console.error('Erro:', error);
                layer.msg(error.message, {icon: 2});
            } finally {
                isLoading = false;
                $loadingMore.hide();
            }
        }

        // Função para verificar scroll
        function checkScroll() {
            const scrollPosition = $(window).scrollTop();
            const windowHeight = $(window).height();
            const documentHeight = $(document).height();
            
            // Carrega mais itens quando estiver perto do final
            if (scrollPosition + windowHeight > documentHeight - 200 && hasMore) {
                loadWithdrawals(currentPage);
            }
        }

        // Botão de voltar
        $backButton.click(function() {
            window.history.back();
        });

        // Evento de scroll
        $(window).scroll(checkScroll);

        // Carrega os primeiros itens
        loadWithdrawals(1);
    });
    </script>
</body>
</html>