<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Renda</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f1f1f1;
        }
        
        .container {
            max-width: 450px;
            margin: 0 auto;
            position: relative;
        }
        
        .header-img {
            width: 100%;
        }
        
        .product-card {
            width: 95%;
            background: #fff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px auto;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .product-image {
            position: absolute;
            right: 10px;
            top: 55px;
        }
        
        .product-image img {
            height: 80px;
            border-radius: 5px;
        }
        
        .product-name {
            height: 35px;
            line-height: 35px;
            margin-left: 3%;
            font-size: 16px;
            color: #3F51B5;
            text-align: left;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .product-details {
            margin-left: 3%;
            margin-bottom: 10px;
        }
        
        .detail-row {
            height: 25px;
            line-height: 25px;
            width: 100%;
            color: #646464;
            font-size: 12px;
            border-radius: 5px;
        }
        
        .detail-label {
            float: left;
        }
        
        .detail-value {
            float: left;
            color: #4CAF50;
            margin-left: 5px;
        }
        
        .status-active {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .status-expired {
            color: #F44336;
            font-weight: bold;
        }
        
        .nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #fff;
            height: 60px;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            text-align: center;
            cursor: pointer;
            padding: 5px 0;
            flex: 1;
        }
        
        .nav-item img {
            height: 28px;
            margin-bottom: 2px;
        }
        
        .nav-item span {
            font-size: 12px;
            display: block;
            color: #666;
        }
        
        .nav-item.active span {
            color: #2E7D32;
            font-weight: bold;
        }
        
        .gray {
            filter: grayscale(100%);
        }
        
        .toast-message {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #272626;
            color: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: fadeInOut 3s forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state img {
            width: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }
        
        .header-title {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: #fff;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho -->
        <div style="position: relative;">
            <img src="https://greenflowmz.com/static/img/share_header_bg.285fc2f1.jpg" class="header-img">
            <div class="header-title">Registro de Renda</div>
            
            <div id="in1" style="position: absolute; top: 20px; right:5px; width: 150px; padding: 10px; border-radius: 5px;">
                <div style="color: #fff; font-size: 16px;">
                    <font id="number1" style="font-weight: bold; font-size: 16px; margin-top: 15px; font-family: HarmonyOS Sans SC;">0</font>
                </div>
                <div style="margin-top: 5px; color: #fff; font-size: 16px;">Saldo Atual >></div>
            </div>
        </div>

        <!-- Lista de Produtos para Registrar Renda -->
        <div id="list" style="margin-bottom: 70px; margin-top: 10px;">
            <!-- Os produtos serão carregados dinamicamente via JavaScript -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="Nenhum produto">
                <h3>Nenhum produto disponível</h3>
                <p>Você não tem produtos ativos para registrar renda.</p>
            </div>
        </div>

        <!-- Menu de Navegação -->
        <nav class="nav">
            <div url="meu.html" class="nav-item navtab">
                <img src="https://popmbbb.cc/ui2/nav/11.png" class="gray" style="height: 28px;"><br>
                <span>Lar</span>
            </div>
            <div url="produtos.html" class="nav-item navtab">
                <img src="https://popmbbb.cc/ui2/nav/2.png" class="gray" style="height: 28px;"><br>
                <span>Produto</span>
            </div>
            <div url="team.html" class="nav-item navtab">
                <img src="https://popmbbb.cc/ui2/nav/33.png" class="gray" style="height: 28px;"><br>
                <span>Equipe</span>
            </div>
            <div class="nav-item" style="color: #2E7D32 !important; font-weight: bold;">
                <img src="https://popmbbb.cc/ui2/nav/44.png" style="height: 28px;"><br>
                <span>Meu</span>
            </div>
        </nav>
    </div>
    
    <!-- Notificação -->
    <div id="toast" style="display: none;" class="toast-message"></div>

    <script>
        // Função para mostrar notificação
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';

            // Reinicia a animação
            toast.classList.remove('toast-message');
            void toast.offsetWidth; // força reflow
            toast.classList.add('toast-message');

            // Esconde depois de 3 segundos
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Carregar produtos ativos do usuário
        async function loadActiveProducts() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/index.html';
                    return;
                }

                // Carrega saldo do usuário
                await loadUserBalance();

                // Busca produtos registrados ativos
                const response = await fetch('https://bd-1-tile.onrender.com/registroproduto', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Filtra apenas produtos ativos
                    const activeProducts = data.data.filter(product => product.status === 'active');
                    
                    if (activeProducts.length > 0) {
                        renderProducts(activeProducts);
                        document.getElementById('emptyState').style.display = 'none';
                    } else {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('list').innerHTML = '';
                        document.getElementById('list').appendChild(document.getElementById('emptyState'));
                    }
                } else {
                    showToast('Erro ao carregar produtos');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao carregar produtos');
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        // Carregar saldo do usuário
        async function loadUserBalance() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/index.html';
                    return;
                }

                const response = await fetch('https://bd-1-tile.onrender.com/user/balance', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('number1').textContent = data.saldo.toLocaleString('pt-PT');
                } else {
                    showToast('Erro ao carregar saldo');
                }
            } catch (error) {
                console.error('Erro ao carregar saldo:', error);
            }
        }

        // Renderizar produtos na página
        function renderProducts(products) {
            const listContainer = document.getElementById('list');
            listContainer.innerHTML = ''; // Limpa produtos existentes
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // Calcula dias restantes
                const purchaseDate = new Date(product.purchaseDate);
                const expirationDate = new Date(purchaseDate);
                expirationDate.setDate(purchaseDate.getDate() + product.days);
                
                const today = new Date();
                const remainingDays = Math.max(0, Math.ceil((expirationDate - today) / (1000 * 60 * 60 * 24)));
                
                // Verifica se já foi registrado hoje
                const lastPayment = product.lastPaymentDate ? new Date(product.lastPaymentDate) : null;
                const canRegister = !lastPayment || 
                                  lastPayment.toDateString() !== today.toDateString();
                
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="https://greenflowmz.com/static/base_head.png">
                    </div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-details">
                        <div class="detail-row">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value status-active">Ativo</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Valor investido:</div>
                            <div class="detail-value">KZ ${product.price.toLocaleString('pt-PT')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Renda diária:</div>
                            <div class="detail-value">KZ ${product.dayIncome.toLocaleString('pt-PT')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Renda acumulada:</div>
                            <div class="detail-value">KZ ${calculateAccumulatedIncome(product)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Dias restantes:</div>
                            <div class="detail-value">${remainingDays} de ${product.days} dias</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Último registro:</div>
                            <div class="detail-value">${lastPayment ? lastPayment.toLocaleDateString('pt-PT') : 'Nunca'}</div>
                        </div>
                        <div class="detail-row" style="margin-top: 10px;">
                            <button id="btn-${product.id}" class="register-income-btn" 
                                    ${canRegister ? '' : 'disabled'}
                                    onclick="registerIncome('${product.id}', '${product.dayIncome}')">
                                ${canRegister ? 'Registrar Renda' : 'Já registrado hoje'}
                            </button>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(productCard);
            });
        }

        // Registrar renda
        async function registerIncome(productId, dayIncome) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/index.html';
                    return;
                }

                // Desativa o botão imediatamente
                const button = document.getElementById(`btn-${productId}`);
                button.disabled = true;
                button.textContent = 'Processando...';
                
                const response = await fetch('https://bd-1-tile.onrender.com/registroproduto/rendimento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        productId,
                        amount: parseFloat(dayIncome)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Renda registrada com sucesso!');
                    // Atualiza o botão para mostrar que já foi registrado hoje
                    button.textContent = 'Já registrado hoje';
                    
                    // Atualizar saldo exibido
                    document.getElementById('number1').textContent = data.newBalance.toLocaleString('pt-PT');
                    
                    // Recarregar produtos após 1.5 segundos
                    setTimeout(() => loadActiveProducts(), 1500);
                } else {
                    showToast(data.message || 'Erro ao registrar renda');
                    // Reativa o botão em caso de erro
                    button.disabled = false;
                    button.textContent = 'Registrar Renda';
                }
            } catch (error) {
                console.error('Erro ao registrar renda:', error);
                showToast('Erro ao registrar renda');
                // Reativa o botão em caso de erro
                const button = document.getElementById(`btn-${productId}`);
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Registrar Renda';
                }
            }
        }

        // Inicialização quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveProducts();
            setupNavButtons();
            
            // Verificar se há token
            if (!localStorage.getItem('token')) {
                window.location.href = '/index.html';
            }
        });
    </script>
</body>
</html>