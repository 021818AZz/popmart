<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Entre na sua conta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.5.6/css/layui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.5.6/layui.min.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
        }

        .inputdiv {
            display: flex;
            border-bottom: 1px solid #999 !important;
            background-color: #fff !important;
            height: 45px;
            line-height: 45px;
            padding: 0px 10px;
            border-radius: 0px;
            color: #000;
        }

        .layui-input {
            border-style: none;
            background-color: #fff !important;
        }

        .login-container {
            width: 95%;
            margin: 0 auto;
            background: #fff;
            border-radius: 5px;
            padding-top: 60px;
            text-align: center;
        }

        .logo {
            margin: 0 auto;
            width: 50%;
            margin-top: 10px;
            border-radius: 5px;
        }

        .login-form {
            margin: 0 auto;
            width: 95%;
            margin-top: 80px;
        }

        .login-btn {
            width: 100%;
            font-weight: 600;
            height: 55px;
            line-height: 55px;
            font-size: 16px;
            display: inline-block;
            background: #D2001F;
            color: #fff;
            border: 1px groove #D2001F;
            border-radius: 5px;
        }

        .register-btn {
            width: 100%;
            font-weight: 600;
            height: 55px;
            line-height: 55px;
            font-size: 16px;
            display: inline-block;
            background: #fff;
            color: #D2001F;
            border: 1px groove #D2001F;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <input type="hidden" id="moblie_qu_hid" value="244" />

    <div style="max-width:480px; margin:0 auto;">
        <div class="login-container">
            <img src="https://popmbbb.cc/ui2/logo.png" class="logo" />
            
            <div class="layui-form login-form">
                <div class="layui-form-item" style="height:48px;">
                    <div class="inputdiv">
                        <i class="layui-icon layui-icon-cellphone" style="margin-right:5px; font-size: 20px; color: #000;"></i>
                        <font style="color: #333; height: 45px; line-height: 45px;" id="moblie_qu">+244</font>
                        <input type="number" id="moblie" oninput="if(value.length>9)value=value.slice(0,9)" 
                               placeholder="Telefone (9 dígitos)" class="layui-input" autocomplete="off">
                    </div>
                </div>
                
                <div class="layui-form-item" style="height:48px; margin-top:10px;">
                    <div class="inputdiv">
                        <i class="layui-icon layui-icon-password" style="margin-right:5px; font-size: 20px; color: #000;"></i>
                        <input type="password" id="password" maxlength="20" 
                               placeholder="Digite sua senha" autocomplete="off" class="layui-input" />
                    </div>
                </div>
                
                <div class="layui-form-item" style="margin-top:20px; color:#000; text-align:center; font-size:14px;">
                    <div style="float:left;width:48%;text-align:left; margin-left:2%; height:25px;line-height:25px;">
                        <input type="checkbox" id="rememberpassword" lay-filter="rememberpassword" 
                               lay-skin="primary" title="Lembrar senha" style="margin-left:0px;">
                    </div>
                </div>
                
                <div class="layui-form-item" style="margin-top:20px; text-align:center;">
                    <button class="layui-btn login-btn" id="login">Faça login agora</button>
                </div>
                
                <div class="layui-form-item" style="margin-top: 20px; text-align: center; color: #D2001F;">
                    ou
                </div>
                
                <div class="layui-form-item" style="margin-top:20px; text-align:center;">
                    <button class="layui-btn register-btn" id="reg">Registre-se agora</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Configuração do LayUI
            layui.use(['layer', 'form'], function(){
                var layer = layui.layer;
                var form = layui.form;
                
                // Função para exibir mensagens
                function showMessage(type, message) {
                    if(type === 'error') {
                        layer.msg(message, {icon: 2, time: 3000});
                    } else {
                        layer.msg(message, {icon: 1, time: 1500});
                    }
                }
                
                // Verificar credenciais salvas
                function checkSavedCredentials() {
                    var rememberpassword = localStorage.getItem("rememberpassword");
                    if (rememberpassword === "1") {
                        var moblie = localStorage.getItem("moblie");
                        var password = localStorage.getItem("password");
                        
                        if (moblie && password) {
                            $("#moblie").val(moblie);
                            $("#password").val(password);
                            $("#rememberpassword").prop("checked", true);
                            form.render();
                        }
                    }
                }
                
                // Evento do checkbox "Lembrar senha"
                form.on('checkbox(rememberpassword)', function(data) {
                    localStorage.setItem("rememberpassword", data.elem.checked ? "1" : "0");
                });
                
                // Evento de login
                $("#login").click(function() {
                    var phone = '+244' + $("#moblie").val().trim();
                    var password = $("#password").val().trim();
                    var rememberMe = $("#rememberpassword").prop("checked");
                    
                    // Validações básicas
                    if (!phone || !password) {
                        showMessage('error', 'Telefone e senha são obrigatórios!');
                        return;
                    }
                    
                    if (!phone.match(/^\+244\d{9}$/)) {
                        showMessage('error', 'Telefone inválido! Deve ter 9 dígitos após +244');
                        return;
                    }
                    
                    var loading = layer.load(1, {shade: [0.5, '#000']});
                    
                    // Requisição de login
                    $.ajax({
                        url: 'http://localhost:3333/login',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ 
                            telefone: phone, 
                            senha: password 
                        }),
                        success: function(response) {
                            layer.close(loading);
                            
                            if (response.success) {
                                // Salvar credenciais se "Lembrar senha" estiver marcado
                                if (rememberMe) {
                                    localStorage.setItem("moblie", $("#moblie").val());
                                    localStorage.setItem("password", password);
                                } else {
                                    localStorage.removeItem("moblie");
                                    localStorage.removeItem("password");
                                }
                                
                                // Armazenar token e redirecionar
                                localStorage.setItem('token', response.token);
                                showMessage('success', 'Login bem-sucedido!');
                                
                                setTimeout(function() {
                                    window.location.href = '/dashboard.html';
                                }, 1500);
                            } else {
                                showMessage('error', response.mensagem || 'Erro no login');
                            }
                        },
                        error: function(xhr) {
                            layer.close(loading);
                            var errorMsg = xhr.responseJSON?.mensagem || 'Erro ao conectar com o servidor';
                            showMessage('error', errorMsg);
                        }
                    });
                });
                
                // Evento de registro
                $("#reg").click(function() {
                    window.location.href = '/registro.html';
                });
                
                // Verificar credenciais salvas ao carregar a página
                checkSavedCredentials();
            });
        });
    </script>
</body>
</html>