<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIGBOX - Ca√ßa-N√≠queis</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQklHQk9YIC0gQ2HDp2EtTsOtcXVlaXMiLCJzaG9ydF9uYW1lIjoiQklHQk9YIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxNjIxM2UiLCJ0aGVtZV9jb2xvciI6IiMxNjIxM2UiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamd1TURBd01EQXhNamd1TURBd01EQWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQSEpsWTNRZ2QybGtkR2c5SWpFeU9DSWdhR1ZwWjJoMFBTSXhNamdpSUdacGJHdzlJaU0wTmpjNVpXRWlMejQ4ZEdWNGRDQjRQU0kyTkNJZ2VUMGlOalFpSUdacGJHdzlJaU0zTmpSaVlUSWlJR1p2Ym5RdGMybDZaVDBpTXpKd2VDSWdkR1Y0ZEMxaGJtTm9iM0k5SW0xcFpHUnNaU0krUGpjOEwzUmxlSFErUEM5emRtYysiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <meta name="theme-color" content="#16213e">
    <link rel="icon" href="https://i.postimg.cc/VNvXp179/image.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            position: relative;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            color: #2ecc71;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .flag {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 20px;
            background: linear-gradient(to bottom, #ff0000 33%, #000000 33% 66%, #ffeb00 66%);
            border-radius: 3px;
        }

        .screen {
            display: none;
            flex: 1;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance {
            font-size: 18px;
            font-weight: bold;
            color: #2ecc71;
        }

        .slot-machine {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            border: 3px solid #2ecc71;
        }

        .reels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .reel {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .symbol {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            border: 2px solid #2ecc71;
            transition: all 0.3s ease;
        }

        .symbol.spinning {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bet-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bet-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #2ecc71;
            color: #333;
            font-weight: bold;
            cursor: pointer;
        }

        .bet-amount {
            font-size: 16px;
            font-weight: bold;
            color: #2ecc71;
            min-width: 80px;
            text-align: center;
        }

        .spin-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .spin-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .spin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2ecc71;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        .message.info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #3498db;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .win-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #2ecc71;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 1000;
            animation: winPulse 2s ease-in-out;
            pointer-events: none;
        }

        @keyframes winPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .logo {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela do Jogo -->
        <div id="gameScreen" class="screen active">
            <button class="logout-btn" onclick="logout()">Sair</button>
            
            <div class="header">
                <div class="flag"></div>
                <div class="logo">
                    <img src="https://i.postimg.cc/VNvXp179/image.png" alt="Logo" class="logo-icon">
                    BIGBOX
                </div>
            </div>
            
            <div class="user-info">
                <div>
                    <div style="font-size: 14px; opacity: 0.8;">Saldo</div>
                    <div class="balance" id="userBalance">KZ 0</div>
                </div>
                <div>
                    <div style="font-size: 14px; opacity: 0.8;">Usu√°rio</div>
                    <div id="userPhone">-</div>
                </div>
            </div>
            
            <div class="game-container">
                <div id="gameMessage"></div>
                
                <div class="slot-machine">
                    <div class="reels" id="reels">
                        <div class="reel">
                            <div class="symbol">üçí</div>
                            <div class="symbol">üçã</div>
                            <div class="symbol">üçä</div>
                        </div>
                        <div class="reel">
                            <div class="symbol">üçá</div>
                            <div class="symbol">üîî</div>
                            <div class="symbol">üíé</div>
                        </div>
                        <div class="reel">
                            <div class="symbol">7Ô∏è‚É£</div>
                            <div class="symbol">‚≠ê</div>
                            <div class="symbol">üçí</div>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <div class="bet-controls">
                            <button class="bet-btn" onclick="adjustBet(-10)">-</button>
                            <div class="bet-amount" id="betAmount">KZ 2</div>
                            <button class="bet-btn" onclick="adjustBet(10)">+</button>
                        </div>
                        
                        <button class="spin-btn" onclick="spin()" id="spinBtn">
                            GIRAR
                        </button>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalWins">KZ 0</div>
                        <div class="stat-label">Total Ganho</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="gamesPlayed">0</div>
                        <div class="stat-label">Jogos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lastWin">KZ 0</div>
                        <div class="stat-label">√öltima Vit√≥ria</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Taxa de Vit√≥ria</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o da API
        const API_BASE = 'https://bd-1-tile.onrender.com'; // Altere para o endere√ßo da sua API
        
        // Estado da aplica√ß√£o
        let currentUser = null;
        let userBalance = 0;
        let currentBet = 2; // Aposta m√≠nima definida para 2 KZ
        let isSpinning = false;
        let gameStats = {
            totalWins: 0,
            gamesPlayed: 0,
            lastWin: 0,
            wins: 0
        };

        // S√≠mbolos do ca√ßa-n√≠queis
        const SYMBOLS = ['üçí', 'üçã', 'üçä', 'üçá', 'üîî', 'üíé', '7Ô∏è‚É£', '‚≠ê'];
        const SYMBOL_VALUES = {
            'üçí': 2, 'üçã': 3, 'üçä': 4, 'üçá': 5,
            'üîî': 10, 'üíé': 20, '7Ô∏è‚É£': 50, '‚≠ê': 100
        };

        // Utilit√°rios
        function formatCurrency(value) {
            return `KZ ${value.toFixed(0)}`;
        }

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Fun√ß√µes de API
        async function apiCall(endpoint, method = 'GET', data = null) {
            const config = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (currentUser && currentUser.token) {
                config.headers.Authorization = `Bearer ${currentUser.token}`;
            }

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                let url = API_BASE;
                if (!url.endsWith('/') && !endpoint.startsWith('/')) {
                    url += '/';
                } else if (url.endsWith('/') && endpoint.startsWith('/')) {
                    endpoint = endpoint.substring(1);
                }
                url += endpoint;

                console.log('Fazendo requisi√ß√£o para:', url);
                
                const response = await fetch(url, config);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.mensagem || 'Erro na requisi√ß√£o');
                }
                
                return result;
            } catch (error) {
                console.error('Erro na API:', error);
                throw error;
            }
        }

        function logout() {
            currentUser = null;
            userBalance = 0;
            gameStats = { totalWins: 0, gamesPlayed: 0, lastWin: 0, wins: 0 };
            localStorage.removeItem('bigbox_user');
            showMessage('gameMessage', 'Sess√£o terminada!', 'success');
        }

        // Fun√ß√µes do jogo
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userBalance').textContent = formatCurrency(userBalance);
                document.getElementById('userPhone').textContent = currentUser.telefone || 'Visitante';
            }
        }

        function updateGameStats() {
            document.getElementById('totalWins').textContent = formatCurrency(gameStats.totalWins);
            document.getElementById('gamesPlayed').textContent = gameStats.gamesPlayed;
            document.getElementById('lastWin').textContent = formatCurrency(gameStats.lastWin);
            
            const winRate = gameStats.gamesPlayed > 0 ? 
                Math.round((gameStats.wins / gameStats.gamesPlayed) * 100) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
        }

        function adjustBet(amount) {
            const newBet = currentBet + amount;
            if (newBet >= 2 && newBet <= userBalance && newBet <= 1000) {
                currentBet = newBet;
                document.getElementById("betAmount").textContent = formatCurrency(currentBet);
            } else if (newBet < 2) {
                showMessage("gameMessage", "A aposta m√≠nima √© de 2 KZ!", "info");
            } else if (newBet > userBalance) {
                showMessage("gameMessage", "Voc√™ n√£o tem saldo suficiente para esta aposta!", "error");
            }
        }

        function generateRandomSymbol() {
            return SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
        }

        function checkWin(reels) {
            let winAmount = 0;
            
            // Verifica linhas horizontais
            for (let row = 0; row < 3; row++) {
                const line = [reels[0][row], reels[1][row], reels[2][row]];
                if (line[0] === line[1] && line[1] === line[2]) {
                    const symbolValue = SYMBOL_VALUES[line[0]];
                    winAmount += symbolValue * (currentBet / 10);
                }
            }

            // Verifica diagonais
            const diagonal1 = [reels[0][0], reels[1][1], reels[2][2]];
            const diagonal2 = [reels[0][2], reels[1][1], reels[2][0]];

            if (diagonal1[0] === diagonal1[1] && diagonal1[1] === diagonal1[2]) {
                const symbolValue = SYMBOL_VALUES[diagonal1[0]];
                winAmount += symbolValue * (currentBet / 10) * 1.5;
            }

            if (diagonal2[0] === diagonal2[1] && diagonal2[1] === diagonal2[2]) {
                const symbolValue = SYMBOL_VALUES[diagonal2[0]];
                winAmount += symbolValue * (currentBet / 10) * 1.5;
            }

            return Math.floor(winAmount);
        }

        async function updateBalance(amount) {
            try {
                userBalance += amount;
                updateUserInfo();
                
                const result = await apiCall('/user/balance');
                if (result.success) {
                    userBalance = result.saldo;
                    updateUserInfo();
                }
            } catch (error) {
                console.error('Erro ao atualizar saldo:', error);
                userBalance -= amount;
                updateUserInfo();
            }
        }

        async function placeBet(betAmount, gameResult) {
            try {
                const result = await apiCall('/game/bet', 'POST', {
                    amount: betAmount,
                    gameType: 'slot_machine',
                    result: gameResult
                });
                
                if (result.success) {
                    userBalance = result.newBalance;
                    updateUserInfo();
                    return result;
                }
            } catch (error) {
                console.error('Erro ao processar aposta:', error);
                throw error;
            }
        }

        async function spin() {
            if (isSpinning || userBalance < currentBet) {
                if (userBalance < currentBet) {
                    showMessage('gameMessage', 'Saldo insuficiente!', 'error');
                }
                return;
            }

            isSpinning = true;
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true;
            spinBtn.textContent = 'GIRANDO...';

            try {
                const finalReels = [
                    [generateRandomSymbol(), generateRandomSymbol(), generateRandomSymbol()],
                    [generateRandomSymbol(), generateRandomSymbol(), generateRandomSymbol()],
                    [generateRandomSymbol(), generateRandomSymbol(), generateRandomSymbol()]
                ];

                const winAmount = checkWin(finalReels);
                
                const betResult = await placeBet(currentBet, {
                    reels: finalReels,
                    winAmount: winAmount,
                    symbols: finalReels.flat()
                });

                gameStats.gamesPlayed++;

                const symbols = document.querySelectorAll('.symbol');
                symbols.forEach(symbol => symbol.classList.add('spinning'));

                const spinDuration = 2000;
                const spinInterval = 100;

                for (let i = 0; i < spinDuration / spinInterval; i++) {
                    setTimeout(() => {
                        symbols.forEach(symbol => {
                            symbol.textContent = generateRandomSymbol();
                        });
                    }, i * spinInterval);
                }

                setTimeout(() => {
                    symbols.forEach(symbol => symbol.classList.remove('spinning'));

                    let symbolIndex = 0;
                    for (let col = 0; col < 3; col++) {
                        for (let row = 0; row < 3; row++) {
                            symbols[symbolIndex].textContent = finalReels[col][row];
                            symbolIndex++;
                        }
                    }

                    if (winAmount > 0) {
                        gameStats.wins++;
                        gameStats.totalWins += winAmount;
                        gameStats.lastWin = winAmount;
                        
                        const winDiv = document.createElement('div');
                        winDiv.className = 'win-animation';
                        winDiv.textContent = `üéâ GANHOU ${formatCurrency(winAmount)}! üéâ`;
                        document.body.appendChild(winDiv);
                        
                        setTimeout(() => {
                            document.body.removeChild(winDiv);
                        }, 2000);
                        
                        showMessage('gameMessage', `Parab√©ns! Voc√™ ganhou ${formatCurrency(winAmount)}!`, 'success');
                    } else {
                        gameStats.lastWin = 0;
                    }

                    updateGameStats();
                    
                    isSpinning = false;
                    spinBtn.disabled = false;
                    spinBtn.textContent = 'GIRAR';
                }, spinDuration);

            } catch (error) {
                console.error('Erro ao processar aposta:', error);
                showMessage('gameMessage', 'Erro ao processar aposta. Tente novamente.', 'error');
                
                isSpinning = false;
                spinBtn.disabled = false;
                spinBtn.textContent = 'GIRAR';
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('bigbox_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    userBalance = currentUser.saldo || 0;
                    updateUserInfo();
                    refreshUserData();
                } catch (error) {
                    localStorage.removeItem('bigbox_user');
                    showMessage('gameMessage', 'Sess√£o expirada. Fa√ßa login novamente.', 'error');
                }
            } else {
                showMessage('gameMessage', 'Nenhum usu√°rio autenticado. Fa√ßa login para jogar.', 'error');
            }

            updateGameStats();
        });

        async function refreshUserData() {
            if (!currentUser || !currentUser.token) return;
            
            try {
                const result = await apiCall('/user/balance');
                if (result.success) {
                    userBalance = result.saldo;
                    updateUserInfo();
                }
            } catch (error) {
                console.error('Erro ao buscar dados do usu√°rio:', error);
                if (error.message.includes('403') || error.message.includes('401')) {
                    logout();
                }
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGNvbnNvbGUubG9nKCdTZXJ2aWNlIFdvcmtlciBpbnN0YWxhZG8nKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
                .then(registration => console.log('Service Worker registrado'))
                .catch(error => console.log('Erro ao registrar Service Worker:', error));
        }
    </script>
</body>
</html>