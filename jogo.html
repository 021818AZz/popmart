<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIGBOX - Caça-Níqueis</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQklHQk9YIC0gQ2HDp2EtTsOtcXVlaXMiLCJzaG9ydF9uYW1lIjoiQklHQk9YIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxNjIxM2UiLCJ0aGVtZV9jb2xvciI6IiMxNjIxM2UiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamd1TURBd01EQXhNamd1TURBd01EQWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQSEpsWTNRZ2QybGtkR2c5SWpFeU9DSWdhR1ZwWjJoMFBTSXhNamdpSUdacGJHdzlJaU0wTmpjNVpXRWlMejQ4ZEdWNGRDQjRQU0kyTkNJZ2VUMGlOalFpSUdacGJHdzlJaU0zTmpSaVlUSWlJR1p2Ym5RdGMybDZaVDBpTXpKd2VDSWdkR1Y0ZEMxaGJtTm9iM0k5SW0xcFpHUnNaU0krUGpjOEwzUmxlSFErUEM5emRtYysiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <meta name="theme-color" content="#16213e">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            position: relative;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .flag {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 20px;
            background: linear-gradient(to bottom, #009739 33%, #fedd00 33% 66%, #009739 66%);
            border-radius: 3px;
        }

        .screen {
            display: none;
            flex: 1;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance {
            font-size: 18px;
            font-weight: bold;
            color: #d4af37;
        }

        .slot-machine {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            border: 3px solid #d4af37;
        }

        .reels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .reel {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .symbol {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            border: 2px solid #d4af37;
            transition: all 0.3s ease;
        }

        .symbol.spinning {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bet-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bet-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bet-input input {
            width: 100px;
            padding: 10px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            color: #333;
            text-align: center;
        }

        .bet-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #d4af37;
            color: #333;
            font-weight: bold;
            cursor: pointer;
        }

        .bet-amount {
            font-size: 16px;
            font-weight: bold;
            color: #d4af37;
            min-width: 80px;
            text-align: center;
        }

        .quick-bets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 5px;
        }

        .quick-bet-btn {
            padding: 8px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-bet-btn:hover {
            background: rgba(212, 175, 55, 0.5);
        }

        .spin-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .spin-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .spin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #d4af37;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
        }

        .message.error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
        }

        .message.info {
            background: rgba(23, 162, 184, 0.2);
            border: 1px solid #17a2b8;
            color: #17a2b8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .win-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 1000;
            animation: winPulse 2s ease-in-out;
            pointer-events: none;
        }

        @keyframes winPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .logo {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela do Jogo -->
        <div id="gameScreen" class="screen active">
            <button class="logout-btn" onclick="window.location.href='meu.html'">Sair</button>
            
            <div class="header">
                <div class="flag"></div>
                <div class="logo">BIGBOX</div>
            </div>
            
            <div class="user-info">
                <div>
                    <div style="font-size: 14px; opacity: 0.8;">Saldo</div>
                    <div class="balance" id="userBalance">KZ 0</div>
                </div>
                <div>
                    <div style="font-size: 14px; opacity: 0.8;">Usuário</div>
                    <div id="userPhone">-</div>
                </div>
            </div>
            
            <div class="game-container">
                <div id="gameMessage"></div>
                
                <div class="slot-machine">
                    <div class="reels" id="reels">
                        <div class="reel">
                            <div class="symbol">🍒</div>
                            <div class="symbol">🍋</div>
                            <div class="symbol">🍊</div>
                        </div>
                        <div class="reel">
                            <div class="symbol">🍇</div>
                            <div class="symbol">🔔</div>
                            <div class="symbol">💎</div>
                        </div>
                        <div class="reel">
                            <div class="symbol">7️⃣</div>
                            <div class="symbol">⭐</div>
                            <div class="symbol">🍒</div>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <div class="bet-controls">
                            <div class="bet-input">
                                <button class="bet-btn" onclick="adjustBet(-50)">-</button>
                                <input type="number" id="betInput" value="50" min="50" max="100000" onchange="validateBet()">
                                <button class="bet-btn" onclick="adjustBet(50)">+</button>
                            </div>
                            <div class="quick-bets">
                                <button class="quick-bet-btn" onclick="setBet(100)">100</button>
                                <button class="quick-bet-btn" onclick="setBet(500)">500</button>
                                <button class="quick-bet-btn" onclick="setBet(1000)">1.000</button>
                                <button class="quick-bet-btn" onclick="setBet(5000)">5.000</button>
                                <button class="quick-bet-btn" onclick="setBet(10000)">10.000</button>
                                <button class="quick-bet-btn" onclick="setBet(50000)">50.000</button>
                            </div>
                        </div>
                        
                        <button class="spin-btn" onclick="spin()" id="spinBtn">
                            GIRAR
                        </button>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalWins">KZ 0</div>
                        <div class="stat-label">Total Ganho</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="gamesPlayed">0</div>
                        <div class="stat-label">Jogos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lastWin">KZ 0</div>
                        <div class="stat-label">Última Vitória</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Taxa de Vitória</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Configuração da API
    const API_BASE = 'http://localhost:3333'; // Altere para o endereço da sua API
    
    // Estado da aplicação
    let currentUser = null;
    let userBalance = 0;
    let currentBet = 50; // Aposta mínima definida para 50 KZ
    let isSpinning = false;
    let gameStats = {
        totalWins: 0,
        gamesPlayed: 0,
        lastWin: 0,
        wins: 0
    };

    // Símbolos do caça-níqueis
    const SYMBOLS = ['🍒', '🍋', '🍊', '🍇', '🔔', '💎', '7️⃣', '⭐'];
    const SYMBOL_VALUES = {
        '🍒': 2, '🍋': 3, '🍊': 4, '🍇': 5,
        '🔔': 10, '💎': 20, '7️⃣': 50, '⭐': 100
    };

    // Utilitários
    function formatCurrency(value) {
        return `KZ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
    }

    function showMessage(elementId, message, type = 'info') {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="message ${type}">${message}</div>`;
        setTimeout(() => {
            element.innerHTML = '';
        }, 5000);
    }

    function validateBet() {
        const betInput = document.getElementById('betInput');
        let value = parseInt(betInput.value);
        
        if (isNaN(value)) {
            value = currentBet;
        } else if (value < 50) {
            value = 50;
            showMessage("gameMessage", "A aposta mínima é de 50 KZ!", "info");
        } else if (value > 100000) {
            value = 100000;
            showMessage("gameMessage", "A aposta máxima é de 100.000 KZ!", "info");
        }
        
        currentBet = value;
        betInput.value = value;
    }

    function setBet(amount) {
        currentBet = amount;
        document.getElementById('betInput').value = amount;
    }

    function adjustBet(amount) {
        const newBet = currentBet + amount;
        if (newBet >= 50 && newBet <= 100000) {
            currentBet = newBet;
            document.getElementById("betInput").value = currentBet;
        } else if (newBet < 50) {
            showMessage("gameMessage", "A aposta mínima é de 50 KZ!", "info");
        } else if (newBet > 100000) {
            showMessage("gameMessage", "A aposta máxima é de 100.000 KZ!", "info");
        }
    }

    // Funções de API
    async function apiCall(endpoint, method = 'GET', data = null) {
        const config = {
            method,
            headers: {
                'Content-Type': 'application/json',
            }
        };

        if (currentUser && currentUser.token) {
            config.headers.Authorization = `Bearer ${currentUser.token}`;
        }

        if (data) {
            config.body = JSON.stringify(data);
        }

        try {
            // Garante que a URL seja construída corretamente
            const url = new URL(endpoint, API_BASE).href;

            console.log('Fazendo requisição para:', url);
            
            const response = await fetch(url, config);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || result.mensagem || 'Erro na requisição');
            }
            
            return result;
        } catch (error) {
            console.error('Erro na API:', error);
            throw error;
        }
    }

    // Funções do jogo
    function updateUserInfo() {
        if (currentUser) {
            document.getElementById('userBalance').textContent = formatCurrency(userBalance);
            document.getElementById('userPhone').textContent = currentUser.telefone;
        }
    }

    function updateGameStats() {
        document.getElementById('totalWins').textContent = formatCurrency(gameStats.totalWins);
        document.getElementById('gamesPlayed').textContent = gameStats.gamesPlayed;
        document.getElementById('lastWin').textContent = formatCurrency(gameStats.lastWin);
        
        const winRate = gameStats.gamesPlayed > 0 ? 
            Math.round((gameStats.wins / gameStats.gamesPlayed) * 100) : 0;
        document.getElementById('winRate').textContent = `${winRate}%`;
    }

    function generateRandomSymbol() {
        return SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
    }

    function checkWin(reels) {
        let winAmount = 0;
        
        // Verifica linhas horizontais
        for (let row = 0; row < 3; row++) {
            const line = [reels[0][row], reels[1][row], reels[2][row]];
            if (line[0] === line[1] && line[1] === line[2]) {
                const symbolValue = SYMBOL_VALUES[line[0]];
                winAmount += symbolValue * (currentBet / 10);
            }
        }

        // Verifica diagonais
        const diagonal1 = [reels[0][0], reels[1][1], reels[2][2]];
        const diagonal2 = [reels[0][2], reels[1][1], reels[2][0]];

        if (diagonal1[0] === diagonal1[1] && diagonal1[1] === diagonal1[2]) {
            const symbolValue = SYMBOL_VALUES[diagonal1[0]];
            winAmount += symbolValue * (currentBet / 10) * 1.5;
        }

        if (diagonal2[0] === diagonal2[1] && diagonal2[1] === diagonal2[2]) {
            const symbolValue = SYMBOL_VALUES[diagonal2[0]];
            winAmount += symbolValue * (currentBet / 10) * 1.5;
        }

        return Math.floor(winAmount);
    }

    async function updateBalance(amount) {
        try {
            // Atualiza localmente primeiro para responsividade
            userBalance += amount;
            updateUserInfo();
            
            // Sincroniza com a API
            const result = await apiCall("/user/balance");
            if (result && result.success) {
                userBalance = result.saldo;
                updateUserInfo();
            } else {
                // Se a API falhar, reverte a mudança local e mostra mensagem de erro
                userBalance -= amount;
                updateUserInfo();
                showMessage("gameMessage", "Erro ao sincronizar saldo com o servidor.", "error");
            }
        } catch (error) {
            console.error("Erro ao atualizar saldo:", error);
            // Em caso de erro, reverte a mudança local
            userBalance -= amount;
            updateUserInfo();
        }
    }

    async function placeBet(betAmount, gameResult) {
        try {
            const result = await apiCall('/game/bet', 'POST', {
                amount: betAmount,
                gameType: 'slot_machine',
                result: gameResult
            });
            
            if (result && result.success) {
                userBalance = result.newBalance;
                updateUserInfo();
                return result;
            }
        } catch (error) {
            console.error('Erro ao processar aposta:', error);
            throw error;
        }
    }

    async function spin() {
        validateBet(); // Valida a aposta antes de girar
        
        if (isSpinning || userBalance < currentBet) {
            if (userBalance < currentBet) {
                showMessage('gameMessage', 'Saldo insuficiente!', 'error');
            }
            return;
        }

        isSpinning = true;
        const spinBtn = document.getElementById('spinBtn');
        spinBtn.disabled = true;
        spinBtn.textContent = 'GIRANDO...';

        try {
            // Gera resultado final primeiro
            const finalReels = [
                [generateRandomSymbol(), generateRandomSymbol(), generateRandomSymbol()],
                [generateRandomSymbol(), generateRandomSymbol(), generateRandomSymbol()],
                [generateRandomSymbol(), generateRandomSymbol(), generateRandomSymbol()]
            ];

            // Verifica vitória
            const winAmount = checkWin(finalReels);
            
            // Processa a aposta na API
            const betResult = await placeBet(currentBet, {
                reels: finalReels,
                winAmount: winAmount,
                symbols: finalReels.flat()
            });

            gameStats.gamesPlayed++;

            // Animação de giro
            const symbols = document.querySelectorAll('.symbol');
            symbols.forEach(symbol => symbol.classList.add('spinning'));

            // Simula o giro por 2 segundos
            const spinDuration = 2000;
            const spinInterval = 100;
            const spinSteps = spinDuration / spinInterval;

            for (let i = 0; i < spinSteps; i++) {
                setTimeout(() => {
                    symbols.forEach(symbol => {
                        symbol.textContent = generateRandomSymbol();
                    });
                }, i * spinInterval);
            }

            // Resultado final após animação
            setTimeout(() => {
                symbols.forEach(symbol => symbol.classList.remove('spinning'));

                // Atualiza a exibição com o resultado real
                let symbolIndex = 0;
                for (let col = 0; col < 3; col++) {
                    for (let row = 0; row < 3; row++) {
                        symbols[symbolIndex].textContent = finalReels[col][row];
                        symbolIndex++;
                    }
                }

                if (winAmount > 0) {
                    gameStats.wins++;
                    gameStats.totalWins += winAmount;
                    gameStats.lastWin = winAmount;
                    
                    // Animação de vitória
                    const winDiv = document.createElement('div');
                    winDiv.className = 'win-animation';
                    winDiv.textContent = `🎉 GANHOU ${formatCurrency(winAmount)}! 🎉`;
                    document.body.appendChild(winDiv);
                    
                    setTimeout(() => {
                        document.body.removeChild(winDiv);
                    }, 2000);
                    
                    showMessage('gameMessage', `Parabéns! Você ganhou ${formatCurrency(winAmount)}!`, 'success');
                } else {
                    gameStats.lastWin = 0;
                }

                updateGameStats();
                
                isSpinning = false;
                spinBtn.disabled = false;
                spinBtn.textContent = 'GIRAR';
            }, spinDuration);

        } catch (error) {
            console.error('Erro ao processar aposta:', error);
            showMessage('gameMessage', 'Erro ao processar aposta. Tente novamente.', 'error');
            
            isSpinning = false;
            spinBtn.disabled = false;
            spinBtn.textContent = 'GIRAR';
        }
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        // Verifica se há usuário logado
        const savedUser = localStorage.getItem('bigbox_user');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                userBalance = currentUser.saldo || 0;
                updateUserInfo();
                
                // Busca dados atualizados da API
                refreshUserData();
            } catch (error) {
                console.error('Erro ao analisar usuário do localStorage:', error);
                localStorage.removeItem('bigbox_user');
                window.location.href = 'meu.html';
            }
        } else {
            // Se não houver usuário, redireciona para a página de login
            window.location.href = 'meu.html';
        }

        // Atualiza estatísticas iniciais
        updateGameStats();
        
        // Configura o input de aposta
        document.getElementById('betInput').addEventListener('change', validateBet);
    });

    // Função para buscar dados atualizados do usuário
    async function refreshUserData() {
        if (!currentUser || !currentUser.token) return;
        
        try {
            const result = await apiCall('/user/balance');
            if (result && result.success) {
                userBalance = result.saldo;
                updateUserInfo();
            }
        } catch (error) {
            console.error('Erro ao buscar dados do usuário:', error);
            // Se o token expirou, redireciona para a página de login
            if (error.message.includes('403') || error.message.includes('401')) {
                localStorage.removeItem('bigbox_user');
                window.location.href = 'meu.html';
            }
        }
    }

    // Registra Service Worker para PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
            .then(registration => console.log('Service Worker registrado com sucesso:', registration.scope))
            .catch(error => console.log('Erro ao registrar Service Worker:', error));
    }
</script>

