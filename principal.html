<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minha Casa</title>
  <script src="js/min.js"></script>
  <script src="js/noty.min.js"></script>
  <link rel="stylesheet" href="noty.min.css">
  <script src="js/tailwindcss.js"></script>
  <link href="js/fonts.googleapis.css" rel="stylesheet">
  <link href="js/boxicons.min.css" rel="stylesheet">
  <style>
    * {
      font-family: 'Poppins', sans-serif;
    }

    .scroll-text {
      animation: slide-left 15s linear infinite;
    }

    @keyframes slide-left {
      from { transform: translateX(100%); }
      to { transform: translateX(-100%); }
    }

    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .animate-slide-up { animation: slideUp 0.4s ease-out; }

    .zoom-in {
      transform: scale(0.85);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .zoom-in.show {
      transform: scale(1);
      opacity: 1;
    }

    @keyframes scaleFadeUp {
      0% { opacity: 0; transform: scale(0.9) translateY(50px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .animate-scale-fade-up { animation: scaleFadeUp 0.4s ease-out forwards; }

    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .animate-slide-down { animation: slideDown 0.4s ease-out; }
    
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #166534; /* Verde escuro */
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
      text-align: center;
    }
  </style>
</head>

<body class="bg-green-50 text-neutral-900 min-h-screen font-sans">
  
  <!-- Toast para mensagens -->
  <div id="toast" class="toast hidden">
    <p id="toast-message"></p>
  </div>

  <div class="mx-auto max-w-sm">
    <img src="img/logo2.png" alt="Banner">
    
    <!-- Seção de Resumo Financeiro -->
    <div class="grid grid-cols-2 gap-2 px-4 mt-2">
      <!-- Card Saldo -->
      <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-3 rounded-xl shadow">
        <p class="text-xs opacity-80 mb-1">Saldo Disponível</p>
        <p class="text-lg font-bold" id="userBalance">KZ0,00</p>
      </div>
      
      <!-- Card Total Retiradas -->
      <div class="bg-gradient-to-r from-emerald-600 to-green-700 text-white p-3 rounded-xl shadow">
        <p class="text-xs opacity-80 mb-1">Total Retirado</p>
        <p class="text-lg font-bold" id="totalWithdrawals">KZ0,00</p>
      </div>
    </div>

    <!-- Seção do Check-in Diário -->
    <div class="px-4 mt-4">
      <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs opacity-80 mb-1">Check-in Diário</p>
            <p class="text-sm font-semibold">Status: <span id="checkin-status">Verificando...</span></p>
          </div>
          <button id="checkin-btn" class="bg-white text-green-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Fazer Check-in
          </button>
        </div>
        <p class="text-xs mt-2 opacity-80">Receba 10 KZ todos os dias fazendo check-in!</p>
      </div>
    </div>

    <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4 rounded-b-3xl shadow">
      <p class="text-sm font-medium">Consultoria financeira gratuita para você.</p>
      <p class="text-xs mt-1">Telefone: <strong id="userPhone">Carregando...</strong></p>
    </div>

    <div class="grid grid-cols-4 gap-2 p-4">
      <a href="deposito.html" class="flex flex-col items-center text-xs text-dark-700 hover:text-green-900">
        <img src="img/retirar.png" class="w-12 mb-1" alt="Recarregar">
        Recarregar
      </a>
      <a href="retirada.html" class="flex flex-col items-center text-xs text-dark-700 hover:text-green-900">
        <img src="img/recarregar.png" class="w-12 mb-1" alt="Retirada">
        Retirada
      </a>
      <a href="equipe.html" class="flex flex-col items-center text-xs text-dark-700 hover:text-green-900">
        <img src="img/presente.png" class="w-12 mb-1" alt="Indicar">
        Indicar
      </a>
      <a href="renda.html" class="flex flex-col items-center text-xs text-dark-700 hover:text-green-900">
        <img src="img/app.png" class="w-12 mb-1" alt="Rendendo">
        Aplicativo
      </a>
    </div>

    <section class="p-4">
      <div class="flex items-center gap-2 mb-3">
        <h4 class="text-green-800 font-semibold text-sm">Projetos em Destaque</h4>
      </div>

      <!-- Lista de produtos -->
      <div class="space-y-4" id="products-container">
        <!-- Os produtos serão carregados dinamicamente via JavaScript -->
      </div>

      <div style="margin-bottom: 60px"></div>
    </section>

     <!-- Menu de navegação com ícones de imagem -->
    <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[500px] z-50 shadow-xl border-t border-green-100 rounded-t-2xl overflow-hidden">
      <ul class="flex justify-around items-center py-2 bg-gradient-to-r from-green-500 via-green-600 to-green-700 text-white text-xs">
        
        <li>
          <a href="principal.html" class="flex flex-col items-center gap-0.5 font-bold">
            <img src="img/home.png" alt="Início" class="w-6 h-6">
            <span>Início</span>
          </a>
        </li>
        
        <li>
          <a href="renda.html" class="flex flex-col items-center gap-0.5 opacity-80">
            <img src="img/produto.png" alt="Renda" class="w-6 h-6">
            <span>Renda</span>
          </a>
        </li>
        
        <li>
          <a href="equipe.html" class="flex flex-col items-center gap-0.5 opacity-80">
            <img src="img/equipe.png" alt="VIP" class="w-6 h-6">
            <span>VIP</span>
          </a>
        </li>
        
        <li>
          <a href="iban.html" class="flex flex-col items-center gap-0.5 opacity-80">
            <img src="img/fortuna.png" alt="Bancária" class="w-6 h-6">
            <span>Bancária</span>
          </a>
        </li>
        
        <li>
          <a href="dashboard.html" class="flex flex-col items-center gap-0.5 opacity-80">
            <img src="img/equipe.png" alt="Perfil" class="w-6 h-6">
            <span>Perfil</span>
          </a>
        </li>

      </ul>
    </nav>


    <!-- Modal de boas-vindas -->
    <div id="customModal" class="fixed inset-0 z-50 bg-black/60 hidden items-center justify-center">
      <div onclick="closeModal()" class="absolute inset-0 cursor-pointer"></div>

      <div id="modalContent" onclick="event.stopPropagation()" class="relative bg-white rounded-2xl shadow-xl max-w-md w-[90%] overflow-hidden animate-slide-down text-gray-800">
        <img src="img/champios.jpg" alt="Destaque" class="w-full h-40 object-cover rounded-t-2xl">

        <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 text-2xl font-bold">
          &times;
        </button>

        <div class="p-6">
          <h2 class="text-xl font-bold mb-2 text-center">Bem vindo(a) à USHK!</h2>
          <p class="text-sm text-gray-600 text-center mb-4">
            USHK no Mundo Desde 1864, ajudando você a prosperar financeiramente. Temos como missão oferecer soluções financeiras de alta qualidade que ajudam pessoas e empresas a prosperarem.
          </p>

          <a href="https://t.me/+1zPkUn3Xwi41MTI0" target="_blank" class="mt-6 block w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white text-center font-semibold py-3 rounded-full text-sm transition">
            Acessar Canal Oficial
          </a>

          <button onclick="closeModal()" class="mt-4 w-full border border-gray-300 text-gray-600 py-2 rounded-full text-sm hover:bg-gray-100">
            Fechar
          </button>
        </div>
      </div>
    </div>

    <script>
      // Configuração da API
      const API_BASE_URL = 'https://bd-p4q7.onrender.com';
      
      // Dados dos produtos atualizados com os novos valores dos campeonatos
      const productsData = [
        {
          id: 1,
          name: "Premier League",
          image: "vip1.png",
          price: 4000,
          dailyReturn: 750,
          totalReturn: 45000,
          period: 60,
          bonusLevel: 1
        },
        {
          id: 2,
          name: "La Liga",
          image: "vip2.png",
          price: 8000,
          dailyReturn: 1500,
          totalReturn: 90000,
          period: 60,
          bonusLevel: 1
        },
        {
          id: 3,
          name: "Serie A",
          image: "vip3.png",
          price: 16000,
          dailyReturn: 3000,
          totalReturn: 180000,
          period: 60,
          bonusLevel: 2
        },
        {
          id: 4,
          name: "Bundesliga",
          image: "vip4.png",
          price: 32000,
          dailyReturn: 6000,
          totalReturn: 360000,
          period: 60,
          bonusLevel: 2
        },
        {
          id: 5,
          name: "Ligue 1",
          image: "vip5.png",
          price: 64000,
          dailyReturn: 12000,
          totalReturn: 720000,
          period: 60,
          bonusLevel: 2
        },
        {
          id: 6,
          name: "Eredivisie",
          image: "img/vip7.png",
          price: 128000,
          dailyReturn: 24000,
          totalReturn: 1440000,
          period: 60,
          bonusLevel: 3
        },
        {
          id: 7,
          name: "Primeira Liga",
          image: "img/vip6.png",
          price: 256000,
          dailyReturn: 48400,
          totalReturn: 2880000,
          period: 60,
          bonusLevel: 3
        },
        {
          id: 8,
          name: "Pro League",
          image: "img/vip8.png",
          price: 512000,
          dailyReturn: 96000,
          totalReturn: 5760000,
          period: 60,
          bonusLevel: 3
        },
        {
          id: 9,
          name: "League Europe",
          image: "img/vip9.png",
          price: 1800000,
          dailyReturn: 192000,
          totalReturn: 11520000,
          period: 60,
          bonusLevel: 3
        }
      ];

      // Função para obter o token do usuário
      function getUserToken() {
          const tokenData = localStorage.getItem('user_token');
          if (!tokenData) return null;
          
          try {
              const { token, expiry } = JSON.parse(tokenData);
              if (Date.now() > expiry) {
                  localStorage.removeItem('user_token');
                  localStorage.removeItem('user_id');
                  return null;
              }
              return token;
          } catch (e) {
              return null;
          }
      }

      // Função para obter o ID do usuário
      function getUserId() {
          return localStorage.getItem('user_id');
      }

      // Toast personalizado
      function showToast(message, type = 'info') {
          const toast = document.getElementById('toast');
          const toastMessage = document.getElementById('toast-message');
          
          toastMessage.textContent = message;
          
          // Estilo baseado no tipo
          if (type === 'success') {
              toast.style.backgroundColor = '#10B981';
          } else if (type === 'error') {
              toast.style.backgroundColor = '#EF4444';
          } else {
              toast.style.backgroundColor = '#166534'; // Verde escuro
          }
          
          toast.classList.remove('hidden');
          toast.style.opacity = '1';
          
          setTimeout(() => {
              toast.style.opacity = '0';
              setTimeout(() => {
                  toast.classList.add('hidden');
              }, 300);
          }, 3000);
      }

      // Carregar dados do usuário
      async function loadUserData() {
          const token = getUserToken();
          const userId = getUserId();
          
          if (!token || !userId) {
              showToast('Faça login para continuar', 'error');
              setTimeout(() => {
                  window.location.href = 'index.html';
              }, 2000);
              return;
          }

          try {
              // Carregar perfil do usuário
              const profileResponse = await fetch(`${API_BASE_URL}/api/user/profile`, {
                  headers: {
                      'Authorization': `Bearer ${token}`
                  }
              });

              if (!profileResponse.ok) {
                  throw new Error('Erro ao carregar dados do usuário');
              }

              const profileData = await profileResponse.json();
              
              if (profileData.success) {
                  // Atualizar saldo
                  document.getElementById('userBalance').textContent = `KZ${profileData.data.wallet_balance.toLocaleString('pt-BR')}`;
               // Exibir número de telefone (mobile) em vez do ID
if (profileData.data.mobile) {
  document.getElementById('userPhone').textContent = profileData.data.mobile;
} else {
  document.getElementById('userPhone').textContent = profileData.data.user_id;
}
              }

              // Carregar total de retiradas
              await loadTotalWithdrawals(token);
              
              // Verificar status do check-in
              await checkCheckinStatus(token);

          } catch (error) {
              console.error('Erro ao carregar dados:', error);
              showToast('Erro ao carregar dados', 'error');
          }
      }

      // Carregar total de retiradas
      async function loadTotalWithdrawals(token) {
          try {
              const response = await fetch(`${API_BASE_URL}/api/withdrawals`, {
                  headers: {
                      'Authorization': `Bearer ${token}`
                  }
              });

              if (response.ok) {
                  const data = await response.json();
                  if (data.success) {
                      const totalWithdrawals = data.data.withdrawals
                          .filter(w => w.status === 'completed')
                          .reduce((sum, withdrawal) => sum + withdrawal.amount, 0);
                      
                      document.getElementById('totalWithdrawals').textContent = `KZ${totalWithdrawals.toLocaleString('pt-BR')}`;
                  }
              }
          } catch (error) {
              console.error('Erro ao carregar retiradas:', error);
          }
      }

      // Verificar status do check-in
      async function checkCheckinStatus(token) {
          try {
              const response = await fetch(`${API_BASE_URL}/api/checkin/status`, {
                  headers: {
                      'Authorization': `Bearer ${token}`
                  }
              });

              if (response.ok) {
                  const data = await response.json();
                  const checkinStatus = document.getElementById('checkin-status');
                  const checkinBtn = document.getElementById('checkin-btn');
                  
                  if (data.success) {
                      if (data.data.can_checkin) {
                          checkinStatus.textContent = 'Disponível';
                          checkinBtn.disabled = false;
                      } else {
                          checkinStatus.textContent = 'Já realizado hoje';
                          checkinBtn.disabled = true;
                          // Mostrar próximo check-in
                          const nextCheckin = new Date(data.data.next_checkin);
                          checkinStatus.textContent = `Próximo: ${nextCheckin.toLocaleTimeString('pt-BR')}`;
                      }
                  }
              }
          } catch (error) {
              console.error('Erro ao verificar check-in:', error);
              document.getElementById('checkin-status').textContent = 'Erro ao verificar';
          }
      }

      // Realizar check-in
      async function performCheckin() {
          const token = getUserToken();
          const checkinBtn = document.getElementById('checkin-btn');
          
          if (!token) {
              showToast('Faça login para continuar', 'error');
              return;
          }

          checkinBtn.disabled = true;
          checkinBtn.textContent = 'Processando...';

          try {
              const response = await fetch(`${API_BASE_URL}/api/checkin`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                  }
              });

              const data = await response.json();

              if (data.success) {
                  showToast('Check-in realizado! +10 KZ adicionados', 'success');
                  document.getElementById('checkin-status').textContent = 'Concluído hoje';
                  
                  // Atualizar saldo
                  await loadUserData();
              } else {
                  showToast(data.message || 'Erro no check-in', 'error');
                  checkinBtn.disabled = false;
              }

          } catch (error) {
              console.error('Erro no check-in:', error);
              showToast('Erro de conexão', 'error');
              checkinBtn.disabled = false;
          } finally {
              checkinBtn.textContent = 'Fazer Check-in';
          }
      }

      // Funções do modal
      function abrirModalCompra(modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
              modal.classList.remove('hidden');
              modal.classList.add('flex');
              document.body.style.overflow = 'hidden';
          }
      }

      function fecharModalCompra(event, modalId) {
          if (event) {
              event.stopPropagation();
          }
          const modal = document.getElementById(modalId);
          if (modal) {
              modal.classList.add('hidden');
              modal.classList.remove('flex');
              document.body.style.overflow = 'auto';
          }
      }

      // Função de investimento
      async function investir(productId, amount) {
          const token = getUserToken();
          
          if (!token) {
              showToast('Faça login para continuar', 'error');
              return;
          }

          // Encontrar o produto nos dados
          const product = productsData.find(p => p.id === productId);
          if (!product) {
              showToast('Produto não encontrado', 'error');
              return;
          }

          // Calcular bônus baseado no nível
          let bonusPercentage = 0;
          if (product.bonusLevel === 1) {
              bonusPercentage = 0.25; // 25% para nível 1
          } else if (product.bonusLevel === 2) {
              bonusPercentage = 0.02; // 2% para nível 2
          } else if (product.bonusLevel === 3) {
              bonusPercentage = 0.01; // 1% para nível 3
          }

          const bonusAmount = amount * bonusPercentage;

          try {
              showToast('Processando investimento...', 'info');

              const response = await fetch(`${API_BASE_URL}/api/purchase`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      product_id: `produto_${productId}`,
                      product_name: product.name,
                      amount: amount,
                      quantity: 1,
                      daily_return: product.dailyReturn,
                      cycle_days: product.period,
                      bonus_amount: bonusAmount
                  })
              });

              const data = await response.json();

              if (data.success) {
                  showToast(`Investimento realizado com sucesso! Bônus de KZ${bonusAmount.toLocaleString('pt-BR')} adicionado`, 'success');
                  
                  // Fechar modal
                  const modalId = `modal-${productId}`;
                  fecharModalCompra(null, modalId);
                  
                  // Recarregar página após 2 segundos
                  setTimeout(() => {
                      window.location.reload();
                  }, 2000);
              } else {
                  showToast(data.message || 'Erro ao realizar investimento', 'error');
              }

          } catch (error) {
              console.error('Erro no investimento:', error);
              showToast('Erro de conexão', 'error');
          }
      }

      // Modal de boas-vindas
      function showWelcomeModal() {
          const modal = document.getElementById('customModal');
          if (modal) {
              modal.classList.remove('hidden');
              modal.classList.add('flex');
              document.body.style.overflow = 'hidden';
          }
      }

      function closeModal() {
          const modal = document.getElementById('customModal');
          if (modal) {
              modal.classList.add('hidden');
              modal.classList.remove('flex');
              document.body.style.overflow = 'auto';
          }
      }

      // Carregar produtos dinamicamente
      function loadProducts() {
          const container = document.getElementById('products-container');
          
          productsData.forEach(product => {
              // Criar elemento do produto
              const productElement = document.createElement('div');
              productElement.className = 'bg-gradient-to-br from-green-50 via-white to-green-100 rounded-3xl p-5 shadow-lg flex items-center justify-between border border-green-200';
              productElement.innerHTML = `
                <div class="flex items-center gap-4">
                  <img src="${product.image}" class="w-20 h-20 rounded-2xl object-cover border-2 border-green-300 shadow-sm" />
                  <div class="space-y-1">
                    <h3 class="text-base font-bold text-green-800">${product.name}</h3>
                    <p class="text-sm text-gray-600">Rendimento diário:</p>
                    <p class="text-lg font-semibold text-green-600">KZ${product.dailyReturn.toLocaleString('pt-BR')}</p>
                    <p class="text-xs text-gray-500 mt-1">Valor do produto</p>
                    <p class="text-base font-bold text-green-500">KZ${product.price.toLocaleString('pt-BR')}</p>
                  </div>
                </div>
                <div class="flex items-center justify-center">
                  <button onclick="abrirModalCompra('modal-${product.id}')"
                    class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 text-sm rounded-full shadow-md hover:brightness-110 transition">
                    comprar
                  </button>
                </div>
              `;
              
              container.appendChild(productElement);
              
              // Criar modal do produto
              const modalElement = document.createElement('div');
              modalElement.id = `modal-${product.id}`;
              modalElement.className = 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm hidden items-center justify-center px-4';
              modalElement.setAttribute('onclick', `fecharModalCompra(event, 'modal-${product.id}')`);
              modalElement.innerHTML = `
                <div onclick="event.stopPropagation()"
                  class="modal-deco relative w-full max-w-md bg-white border-2 border-green-500 rounded-3xl p-6 animate-scale-fade-up shadow-2xl">
                  <button onclick="fecharModalCompra(null, 'modal-${product.id}')"
                    class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
                  <div class="flex items-center gap-4 mb-4">
                    <img src="${product.image}" class="w-12 h-12 rounded-full" />
                    <div>
                      <h3 class="text-lg font-bold text-green-800">${product.name}</h3>
                      <p class="text-sm font-semibold text-green-700">KZ${product.price.toLocaleString('pt-BR')}</p>
                    </div>
                  </div>
                  <ul class="text-sm text-gray-700 mb-6">
                    <li>Diário: <strong>KZ${product.dailyReturn.toLocaleString('pt-BR')}</strong></li>
                    <li>Total: <strong>KZ${product.totalReturn.toLocaleString('pt-BR')}</strong></li>
                    <li>Dias: <strong>${product.period} dias</strong></li>
                    <li>Bônus: <strong>${product.bonusLevel === 1 ? '25%' : product.bonusLevel === 2 ? '2%' : '1%'}</strong></li>
                  </ul>
                  <button onclick="investir(${product.id}, ${product.price})"
                    class="block w-full text-center bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl text-sm font-semibold">
                    Investir agora
                  </button>
                </div>
              `;
              
              container.appendChild(modalElement);
          });
      }

      // Event Listeners
      document.addEventListener('DOMContentLoaded', function() {
          // Carregar dados do usuário
          loadUserData();
          
          // Carregar produtos
          loadProducts();
          
          // Mostrar modal de boas-vindas sempre que a página for carregada
          setTimeout(showWelcomeModal, 1000);
          
          // Event listener para check-in
          const checkinBtn = document.getElementById('checkin-btn');
          if (checkinBtn) {
              checkinBtn.addEventListener('click', performCheckin);
          }
          
          // Event listeners para tecla Escape nos modais
          document.addEventListener('keydown', function(event) {
              if (event.key === 'Escape') {
                  closeModal();
                  // Fechar todos os modais de produtos
                  productsData.forEach(product => {
                      fecharModalCompra(null, `modal-${product.id}`);
                  });
              }
          });
      });

      // Função para formatar valores em KZ
      function formatCurrency(value) {
          return `KZ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      // Verificar autenticação em todas as páginas
      function checkAuth() {
          const token = getUserToken();
          if (!token) {
              window.location.href = 'index.html';
              return false;
          }
          return true;
      }

      // Logout function (se necessário)
      function logout() {
          localStorage.removeItem('user_token');
          localStorage.removeItem('user_id');
          localStorage.removeItem('hasVisited');
          window.location.href = 'index.html';
      }
    </script>
  </div>
</body>
</html>