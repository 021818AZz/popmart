<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=0,initial-scale=1,maximum-scale=1, minimum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Minha Conta</title>
    <link href="https://popmbbb.cc/Lay/css/layui.css?v1.6" rel="stylesheet" />
    <link href="https://popmbbb.cc/css/main.css?v2.7" rel="stylesheet" />
    <link href="https://popmbbb.cc/layer_mobile/need/layer.css?v1.6" rel="stylesheet" />
    <script src="https://popmbbb.cc/Lay/layui.js?v1.7"></script>
    <script src="https://popmbbb.cc/js/comm.js?v1.7"></script>
    <script src="https://popmbbb.cc/js/jquery-1.11.0.min.js"></script>
    <style type="text/css">
        /* Estilos gerais */
        body {
            min-height: 100%; 
            width: 100%; 
            background: #f5f5f5;
            font-family: 'HarmonyOS Sans SC', sans-serif;
        }
        
        div {
            cursor: pointer;
        }
        
        /* Estilo para loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #28a745;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Estilo para valores monetários */
        .currency-value {
            font-weight: bold;
            color: #28a745;
        }
        
        /* Estilo para cabeçalho */
        .user-header {
            position: relative;
            height: 180px;
            background: linear-gradient(135deg, #2e362f, #f1f3f1);
            border-radius: 0 0 20px 20px;
            padding: 15px;
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            text-align: center;
        }
        
        .info-item {
            flex: 1;
            padding: 0 10px;
        }
        
        .info-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        /* Botão de logout */
        .logout-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
        }
        
        /* Cartão de ações */
        .action-card {
            background: white;
            border-radius: 15px;
            margin: 15px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .action-grid {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .action-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .action-item:hover {
            background: rgba(40, 167, 69, 0.1);
            transform: translateY(-3px);
        }
        
        .action-icon {
            width: 36px;
            height: 36px;
            margin-bottom: 8px;
        }
        
        .action-label {
            font-size: 12px;
            color: #333;
        }
        
        /* Seção de serviços */
        .services-section {
            margin: 15px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .section-divider {
            border: none;
            height: 1px;
            background: #e0e0e0;
            margin: 10px 0;
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .service-item {
            background: white;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .service-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .service-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            color: #28a745;
        }
        
        .service-label {
            font-size: 12px;
            color: #333;
        }
        
        /* Navegação */
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 450px;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            border-radius: 15px 15px 0 0;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
        }
        
        .nav-item.active {
            color: #28a745;
            font-weight: bold;
        }
        
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 3px;
        }
        
        .gray {
            filter: grayscale(100%);
        }
    </style>
</head>
<body>
    <input type="hidden" id="telegram" value="" />
    <input type="hidden" id="androidurl" value="" />

    <div style="max-width:450px; margin:0 auto; padding-bottom: 70px;">
        <div class="top1"></div>
        
        <!-- Cabeçalho do usuário -->
        <div class="user-header">
            <!-- Botão de logout -->
            <button id="outlogin" class="logout-btn">
                <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="white">
                    <path d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" />
                </svg>
                Sair
            </button>

            <!-- Avatar -->
            <div class="user-avatar">
                <img src="https://greenflowmz.com/static/base_head.png" style="width: 100%; height: 100%; object-fit: cover;" />
            </div>

            <!-- Informações do usuário -->
            <div class="user-info">
                <div class="info-item">
                    <div id="uid" style="font-size: 14px; font-weight: bold;"><span class="loading"></span></div>
                    <div class="info-label">Número de telefone</div>
                </div>
                <div class="info-item">
                    <div id="useramount" class="currency-value" style="font-size: 16px;"><span class="loading"></span></div>
                    <div class="info-label">Saldo da conta</div>
                </div>
            </div>
        </div>

        <!-- Cartão de ações principais -->
        <div class="action-card">
            <div style="font-weight: bold; color: #333;">Ações rápidas</div>
            <div class="action-grid">
                <div class="action-item" onclick="window.location.href='deposito.html'">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="#28a745">
                        <path d="M12,15A2,2 0 0,1 14,17C14,18.11 13.1,19 12,19C10.89,19 10,18.11 10,17A2,2 0 0,1 12,15M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M16,14H15.5A1.5,1.5 0 0,1 14,12.5V10H10V12.5C10,13.88 11.12,15 12.5,15H16V18L19,15L16,12V14Z" />
                    </svg>
                    <div class="action-label">Recarregar</div>
                </div>
                
                <div class="action-item" onclick="window.location.href='retirada.html'">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="#28a745">
                        <path d="M14,12H10V10H14M14,16H10V14H14M20,8H17.19C16.74,7.22 16.12,6.55 15.37,6.04L17,4.41L15.59,3L13.42,5.17C12.96,5.06 12.5,5 12,5C11.5,5 11.04,5.06 10.59,5.17L8.41,3L7,4.41L8.62,6.04C7.88,6.55 7.26,7.22 6.81,8H4V10H6.09C6.04,10.33 6,10.66 6,11V12H4V14H6V15C6,15.34 6.04,15.67 6.09,16H4V18H6.81C8.47,20.87 12.14,21.84 15,20.18C15.91,19.66 16.67,18.9 17.19,18H20V16H17.91C17.96,15.67 18,15.34 18,15V14H20V12H18V11C18,10.66 17.96,10.33 17.91,10H20V8Z" />
                    </svg>
                    <div class="action-label">Retirada</div>
                </div>
                
                <div class="action-item" onclick="window.location.href='https://popmbbb.cc/main/prop/accountdetails.html'">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="#28a745">
                        <path d="M12,3C16.97,3 21,7.03 21,12H19C19,8.14 15.86,5 12,5C8.14,5 5,8.14 5,12C5,15.86 8.14,19 12,19C14.39,19 16.53,17.77 17.86,15.86L19.26,17.26C17.53,19.69 14.96,21 12,21C7.03,21 3,16.97 3,12C3,7.03 7.03,3 12,3M11,8H13V16H11V8M15,1H9V3H15V1Z" />
                    </svg>
                    <div class="action-label">Registros</div>
                </div>
            </div>
        </div>

        <!-- Seção de serviços -->
        <div class="services-section">
            <div class="section-title">
                <svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="#28a745">
                    <path d="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V5H19V19M17,17H7V7H17V17M14,14H10V10H14V14Z" />
                </svg>
                Outros serviços
            </div>
            <hr class="section-divider" />
            
            <div class="services-grid">
                <div class="service-item" onclick="window.location.href='sobre.html?id=1'">
                    <svg class="service-icon" viewBox="0 0 24 24">
                        <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
                    </svg>
                    <div class="service-label">Sobre nós</div>
                </div>
                
                <div class="service-item" onclick="window.location.href='sobre.html?id=2'">
                    <svg class="service-icon" viewBox="0 0 24 24">
                        <path d="M12,3L2,12H5V20H19V12H22L12,3M12,7.7C14.1,7.7 15.8,9.4 15.8,11.5C15.8,14.5 12,18 12,18C12,18 8.2,14.5 8.2,11.5C8.2,9.4 9.9,7.7 12,7.7M12,10A1.5,1.5 0 0,0 10.5,11.5A1.5,1.5 0 0,0 12,13A1.5,1.5 0 0,0 13.5,11.5A1.5,1.5 0 0,0 12,10Z" />
                    </svg>
                    <div class="service-label">Regras</div>
                </div>
                
                <div class="service-item" onclick="window.location.href='servico.html'">
                    <svg class="service-icon" viewBox="0 0 24 24">
                        <path d="M12,3C6.5,3 2,6.58 2,11C2.05,13.15 3.06,15.17 4.75,16.5C4.75,17.1 4.33,18.67 2,21C4.37,20.89 6.64,20 8.47,18.5C9.61,18.83 10.81,19 12,19C17.5,19 22,15.42 22,11C22,6.58 17.5,3 12,3M12,17C7.58,17 4,14.31 4,11C4,7.69 7.58,5 12,5C16.42,5 20,7.69 20,11C20,14.31 16.42,17 12,17Z" />
                    </svg>
                    <div class="service-label">Suporte</div>
                </div>
                
                <div class="service-item" id="down">
                    <svg class="service-icon" viewBox="0 0 24 24">
                        <path d="M5,3H19A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3M18,5H15.5A3.5,3.5 0 0,0 12,8.5V11H10V14H12V21H15V14H18V11H15V9A1,1 0 0,1 16,8H18V5Z" />
                    </svg>
                    <div class="service-label">Baixar App</div>
                </div>
            </div>
        </div>
               
        <div class="service-item" onclick="window.location.href='jogo.html'">
            <svg class="service-icon" viewBox="0 0 24 24">
                <path d="M5,8C3.9,8 3,8.9 3,10V14C3,15.1 3.9,16 5,16H8L11,19H13L16,16H19C20.1,16 21,15.1 21,14V10C21,8.9 20.1,8 19,8H5M8,12.5C7.17,12.5 6.5,11.83 6.5,11C6.5,10.17 7.17,9.5 8,9.5C8.83,9.5 9.5,10.17 9.5,11C9.5,11.83 8.83,12.5 8,12.5M16,12.5C15.17,12.5 14.5,11.83 14.5,11C14.5,10.17 15.17,9.5 16,9.5C16.83,9.5 17.5,10.17 17.5,11C17.5,11.83 16.83,12.5 16,12.5Z" />
            </svg>
            <div class="service-label">Jogar</div>
        </div>

        <!-- Navegação inferior -->
        <nav class="nav">
            <div onclick="window.location.href='dashboard.html'" class="nav-item">
                <svg class="nav-icon gray" viewBox="0 0 24 24">
                    <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
                </svg>
                <span><br>Lar</span>
            </div>
            <div onclick="window.location.href='produto.html'" class="nav-item">
                <svg class="nav-icon gray" viewBox="0 0 24 24">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z" />
                </svg>
                <span><br>Produto</span>
            </div>
            <div onclick="window.location.href='team.html'" class="nav-item">
                <svg class="nav-icon gray" viewBox="0 0 24 24">
                    <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                </svg>
                <span><br>Equipe</span>
            </div>
            <div class="nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="#28a745">
                    <path d="M12,19.2C9.5,19.2 7.29,17.92 6,16C6.03,14 10,12.9 12,12.9C14,12.9 17.97,14 18,16C16.71,17.92 14.5,19.2 12,19.2M12,5A3,3 0 0,1 15,8A3,3 0 0,1 12,11A3,3 0 0,1 9,8A3,3 0 0,1 12,5M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12C22,6.47 17.5,2 12,2Z" />
                </svg>
                <span><br>Meu</span>
            </div>
        </nav>
    </div>

    <script>
        // Função para formatar valores em KZ (Kwanza Angolano)
        function formatCurrency(value) {
            if (isNaN(value)) value = 0;
            return 'KZ ' + parseFloat(value).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Função para formatar número de telefone
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            
            // Formatar números brasileiros (assumindo formato 55XXXXXXXXXXX)
            if (phone.startsWith('55') && phone.length >= 12) {
                return phone.replace(/(\d{2})(\d{2})(\d{5})(\d{4})/, '+$1 ($2) $3-$4');
            }
            // Formatar números angolanos (assumindo formato 244XXXXXXXXX)
            else if (phone.startsWith('244') && phone.length >= 12) {
                return phone.replace(/(\d{3})(\d{3})(\d{3})(\d{3})/, '+$1 $2 $3 $4');
            }
            // Formato internacional padrão
            else if (phone.startsWith('+')) {
                return phone.replace(/(\+\d{3})(\d{3})(\d{3})(\d{3})/, '$1 $2 $3 $4');
            }
            
            return phone;
        }

        // Função para buscar dados do usuário
        async function fetchUserData() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/index.html';
                return;
            }

            // Mostrar loading
            document.getElementById('uid').innerHTML = '<span class="loading"></span>';
            document.getElementById('useramount').innerHTML = '<span class="loading"></span>';

            try {
                // Verificar cache primeiro (válido por 30 segundos)
                const cachedData = sessionStorage.getItem('userDataCache');
                const cacheTime = sessionStorage.getItem('userDataCacheTime');
                
                if (cachedData && cacheTime && (Date.now() - cacheTime < 30000)) {
                    updateUserUI(JSON.parse(cachedData));
                }

                // Buscar dados atualizados
                const response = await fetch('https://bd-1-tile.onrender.com/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) throw new Error('Erro na rede');

                const data = await response.json();
                
                if (data.success) {
                    // Armazenar em cache
                    sessionStorage.setItem('userDataCache', JSON.stringify(data));
                    sessionStorage.setItem('userDataCacheTime', Date.now());
                    updateUserUI(data);
                } else {
                    throw new Error(data.mensagem || 'Erro ao buscar dados');
                }
            } catch (error) {
                console.error('Erro:', error);
                // Tentar usar dados em cache se disponível
                const cachedData = sessionStorage.getItem('userDataCache');
                if (cachedData) {
                    updateUserUI(JSON.parse(cachedData));
                } else {
                    document.getElementById('uid').textContent = 'Erro ao carregar';
                    document.getElementById('useramount').textContent = 'Erro ao carregar';
                }
            }
        }

        // Atualizar a interface com os dados do usuário
        function updateUserUI(data) {
            // Formatar e exibir telefone
            const phone = data.user.telefone || '';
            document.getElementById('uid').textContent = formatPhoneNumber(phone);
            
            // Formatar e exibir saldo
            document.getElementById('useramount').textContent = formatCurrency(data.user.saldo);
        }

        // Inicialização quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            if (!localStorage.getItem('token')) {
                window.location.href = '/index.html';
                return;
            }

            // Carregar dados imediatamente
            fetchUserData();

            // Atualizar a cada 30 segundos
            setInterval(fetchUserData, 30000);
        });

        // Configuração do LayUI e event listeners
        layui.use(['layer', 'jquery'], function() {
            var layer = layui.layer;
            var $ = layui.jquery;

            // Logout
            $(document).on("click", '#outlogin', function() {
                layer.confirm('Tem certeza que deseja sair?', {
                    btn: ['Sim', 'Não'],
                    title: 'Confirmação',
                    skin: 'layui-layer-molv'
                }, function() {
                    // Limpar cache e redirecionar
                    sessionStorage.removeItem('userDataCache');
                    sessionStorage.removeItem('userDataCacheTime');
                    localStorage.removeItem('token');
                    window.location.href = "/index.html?time=" + Math.random();
                });
            });

            // Download App
            $(document).on("click", '#down', function() {
                layer.msg("O aplicativo está em desenvolvimento.", {icon: 1});
            });
        });
    </script>
</body>
</html>